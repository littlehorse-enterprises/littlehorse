image: ubuntu:22.04

definitions:
  services:
      docker:
        memory: 3072
  steps:
    - step: &build-test
        name: Build and Test
        script:
          - apt-get update && apt-get install -y openjdk-11-jdk-headless openjdk-17-jdk-headless
          - ./gradlew test shadowJar
    - step: &build-docker-image
        size: 2x
        deployment: production
        name: Build and Deploy Docker Image
        services:
          - docker
        script:
          - >-
            export TAG="$([ ! -z "$BITBUCKET_BRANCH" ] && ([ "$BITBUCKET_BRANCH" = "master" ] && echo "master"
            || echo "branch-${BITBUCKET_BRANCH/\//-}") || echo $BITBUCKET_TAG)"
          - echo "Tag to be used:" $TAG
          - export REPOSITORY_NAME=littlehorse-server
          - docker build --file docker/Dockerfile -t $REPOSITORY_NAME:$TAG .
          - pipe: atlassian/aws-ecr-push-image:2.0.0
            variables:
              AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID
              AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
              AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION
              IMAGE_NAME: "${REPOSITORY_NAME}"
              TAGS: "${TAG}"

pipelines:
  tags:
    "*":
      - step: *build-test
      - step: *build-docker-image

  default:
    - step: *build-test
    - step:
        <<: *build-docker-image
        trigger: manual
