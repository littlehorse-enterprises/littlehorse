syntax = "proto3";

package littlehorse;

import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";
import "common_wfspec.proto";
import "common_enums.proto";
import "object_id.proto";
import "variable.proto";
import "external_event.proto";
import "wf_run.proto";
import "node_run.proto";
import "task_run.proto";
import "user_tasks.proto";
import "wf_spec.proto";
import "task_def.proto";
import "acls.proto";

option go_package = ".;model";
option java_multiple_files = true;
option java_package = "io.littlehorse.sdk.common.proto";
option csharp_namespace = "LittleHorse.Common.Proto";

message GetLatestUserTaskDefRequest {
  string name = 1;
}

message PutWfSpecRequest {
  string name = 1;
  reserved 2, 3, 4;
  map<string, ThreadSpec> thread_specs = 5;
  string entrypoint_thread_name = 6;
  optional WorkflowRetentionPolicy retention_policy = 8;
  reserved 9;
  AllowedUpdateType allowed_updates = 10;
}

// Defines the allowed update type
// ALL_UPDATES - Creates either a revision or majorVersion when WfSpec changes
// MINOR_REVISION_UPDATES - Allow revision updates but reject majorVersion
// NO_UPDATES - Reject any update
enum AllowedUpdateType {
  ALL_UPDATES = 0;
  MINOR_REVISION_UPDATES = 1;
  NO_UPDATES = 2;
}

message PutTaskDefRequest {
  string name = 1;
  repeated VariableDef input_vars = 2;
}

message PutUserTaskDefRequest {
  string name = 1;
  repeated UserTaskField fields = 2;
  optional string description = 3;
}

message PutExternalEventDefRequest {
  string name = 1;
  ExternalEventRetentionPolicy retention_policy = 2;
}

message PutExternalEventRequest {
  WfRunId wf_run_id = 1;
  ExternalEventDefId external_event_def_id = 2;
  optional string guid = 3;
  VariableValue content = 5;
  optional int32 thread_run_number = 6;
  optional int32 node_run_position = 7;
  reserved 4, 8;
}

message DeleteExternalEventRequest {
  ExternalEventId id = 1;
}

message DeleteWfRunRequest {
  WfRunId id = 1;
}

message DeleteTaskDefRequest {
  TaskDefId id = 1;
}

message DeleteUserTaskDefRequest {
  UserTaskDefId id = 1;
}

message DeleteWfSpecRequest {
  WfSpecId id = 1;
}

message DeleteExternalEventDefRequest {
  ExternalEventDefId id = 1;
}

message RunWfRequest {
  string wf_spec_name = 1;
  optional int32 major_version = 2;
  optional int32 revision = 3;
  map<string, VariableValue> variables = 4;
  optional string id = 5;
}

message VariableMatch {
    string var_name = 1;
    VariableValue value = 2;
}

message SearchWfRunRequest {
    optional bytes bookmark = 1;
    optional int32 limit = 2;

    string wf_spec_name = 3;
    optional int32 wf_spec_major_version = 4;
    optional int32 wf_spec_revision = 5;
    optional LHStatus status = 6;

    optional google.protobuf.Timestamp earliest_start = 7;
    optional google.protobuf.Timestamp latest_start = 8;

    // Allows filtering WfRun's based on the value of the Variables. This ONLY
    // works for the Variables in the entrypiont threadrun (that is, variables
    // where the threadRunNumber == 0).
    repeated VariableMatch variable_filters = 9;
}

message WfRunIdList {
  repeated WfRunId results = 1;
  optional bytes bookmark = 2;
}

message SearchTaskRunRequest {
    optional bytes bookmark = 1;
    optional int32 limit = 2;
    string task_def_name = 3;
    optional TaskStatus status = 4;

    optional google.protobuf.Timestamp earliest_start = 5;
    optional google.protobuf.Timestamp latest_start = 6;
}

message TaskRunIdList {
  repeated TaskRunId results = 1;
  optional bytes bookmark = 2;
}

message SearchNodeRunRequest {
  enum NodeType {
    TASK = 0;
    EXTERNAL_EVENT = 1;
    ENTRYPOINT = 2;
    EXIT = 3;
    START_THREAD = 4;
    WAIT_THREADS = 5;
    SLEEP = 6;
    USER_TASK = 7;
    START_MULTIPLE_THREADS = 8;
  }

  optional bytes bookmark = 1;
  optional int32 limit = 2;
  optional google.protobuf.Timestamp earliest_start = 3;
  optional google.protobuf.Timestamp latest_start = 4;

  NodeType node_type = 5;
  LHStatus status = 6;
}

message NodeRunIdList {
  repeated NodeRunId results = 1;
  optional bytes bookmark = 2;
}

message SearchUserTaskRunRequest {
  optional bytes bookmark = 1;
  optional int32 limit = 2;

  optional UserTaskRunStatus status = 3;
  optional string user_task_def_name = 4;

  optional string user_id = 5;
  optional string user_group = 6;

  optional google.protobuf.Timestamp earliest_start = 7;
  optional google.protobuf.Timestamp latest_start = 8;
}

message UserTaskRunIdList {
  repeated UserTaskRunId results = 1;
  optional bytes bookmark = 2;
}

message SearchVariableRequest {
  optional bytes bookmark = 1;
  optional int32 limit = 2;

  VariableValue value = 3;
  optional int32 wf_spec_major_version = 4;
  optional int32 wf_spec_revision = 5;
  string var_name = 6;
  string wf_spec_name = 7;
}

message VariableIdList {
  repeated VariableId results = 1;
  optional bytes bookmark = 2;
}

message SearchTaskDefRequest {
  optional bytes bookmark = 1;
  optional int32 limit = 2;
  optional string prefix = 3;
}

message TaskDefIdList {
  repeated TaskDefId results = 1;
  optional bytes bookmark = 2;
}

message SearchUserTaskDefRequest {
  optional bytes bookmark = 1;
  optional int32 limit = 2;
  oneof user_task_def_criteria {
    string prefix = 3;
    string name = 4;
  }
}

message UserTaskDefIdList {
  repeated UserTaskDefId results = 1;
  optional bytes bookmark = 2;
}

message SearchWfSpecRequest {
  optional bytes bookmark = 1;
  optional int32 limit = 2;
  oneof wf_spec_criteria {
    string name = 3;
    string prefix = 4;
    string task_def_name = 5;
  }
}

message WfSpecIdList {
  repeated WfSpecId results = 1;
  optional bytes bookmark = 2;
}

message SearchExternalEventDefRequest {
  optional bytes bookmark = 1;
  optional int32 limit = 2;
  optional string prefix = 3;
}

message ExternalEventDefIdList {
  repeated ExternalEventDefId results = 1;
  optional bytes bookmark = 2;
}

message SearchExternalEventRequest {
  optional bytes bookmark = 1;
  optional int32 limit = 2;

  message ByExtEvtDefNameAndStatusRequest {
    string external_event_def_name = 1;
    optional bool is_claimed = 2;
  }

  oneof ext_evt_criteria {
    WfRunId wf_run_id = 3;
    ByExtEvtDefNameAndStatusRequest external_event_def_name_and_status = 4;
  }
}

message ExternalEventIdList {
  repeated ExternalEventId results = 1;
  optional bytes bookmark = 2;
}

message ListNodeRunsRequest {
  WfRunId wf_run_id = 1;
}

message NodeRunList {
  repeated NodeRun results = 1;
}

message ListVariablesRequest {
  WfRunId wf_run_id = 1;
}

message VariableList {
  repeated Variable results = 1;
}

message ListExternalEventsRequest {
  WfRunId wf_run_id = 1;
}

message ExternalEventList {
  repeated ExternalEvent results = 1;
}

message RegisterTaskWorkerRequest {
  string client_id = 1;
  TaskDefId task_def_id = 2;
  string listener_name = 3;
}

message TaskWorkerHeartBeatRequest {
  string client_id = 1;
  TaskDefId task_def_id = 2;
  string listener_name = 3;
}

message RegisterTaskWorkerResponse {
  repeated LHHostInfo your_hosts = 1;
  optional bool is_cluster_healthy = 2;
}

message LHHostInfo {
  string host = 1;
  int32 port = 2;
}

message TaskWorkerMetadata {
  string client_id = 1;
  google.protobuf.Timestamp latest_heartbeat = 2;
  repeated LHHostInfo hosts = 3;
}

message TaskWorkerGroup {
  TaskWorkerGroupId id = 1;
  google.protobuf.Timestamp created_at = 2;
  map<string, TaskWorkerMetadata> task_workers = 3;
}

message PollTaskRequest {
  TaskDefId task_def_id = 1;
  string client_id = 2;
  optional string task_worker_version = 3;
}

message ScheduledTask {
  TaskRunId task_run_id = 1;
  TaskDefId task_def_id = 2;
  int32 attempt_number = 3;
  repeated VarNameAndVal variables = 4;
  google.protobuf.Timestamp created_at = 5;
  TaskRunSource source = 6;
}

message PollTaskResponse {
  optional ScheduledTask result = 1;
}

message ReportTaskRun {
  TaskRunId task_run_id = 1;
  google.protobuf.Timestamp time = 2;
  TaskStatus status = 3;
  optional VariableValue log_output = 5;
  int32 attempt_number = 6;
  oneof result {
    VariableValue output = 4;
    LHTaskError error = 7;
    LHTaskException exception = 8;
  }

}

message StopWfRunRequest {
  WfRunId wf_run_id = 1;
  int32 thread_run_number = 2;
}

message ResumeWfRunRequest {
  WfRunId wf_run_id = 1;
  int32 thread_run_number = 2;
}

enum LHHealthResult {
  LH_HEALTH_RUNNING = 0;
  LH_HEALTH_REBALANCING = 1;
  LH_HEALTH_ERROR = 2;
}

message TaskDefMetricsQueryRequest {
  google.protobuf.Timestamp window_start = 1;
  MetricsWindowLength window_type = 2;
  optional string task_def_name = 3;
}

message ListTaskMetricsRequest {
  TaskDefId task_def_id = 1;
  google.protobuf.Timestamp last_window_start = 2;
  MetricsWindowLength window_length = 3;
  int32 num_windows = 4;
}

message ListTaskMetricsResponse {
  repeated TaskDefMetrics results = 1;
}

message WfSpecMetricsQueryRequest {
  WfSpecId wf_spec_id = 1;
  google.protobuf.Timestamp window_start = 2;
  MetricsWindowLength window_length = 3;
}

message ListWfMetricsRequest {
  WfSpecId wf_spec_id = 1;
  google.protobuf.Timestamp last_window_start = 2;
  MetricsWindowLength window_length = 3;
  int32 num_windows = 4;
}

message ListWfMetricsResponse {
  repeated WfSpecMetrics results = 1;
}

message TaskDefMetrics {
  TaskDefId task_def_id = 1;
  google.protobuf.Timestamp window_start = 2;
  MetricsWindowLength type = 3;

  int64 schedule_to_start_max = 4;
  int64 schedule_to_start_avg = 5;
  int64 start_to_complete_max = 6;
  int64 start_to_complete_avg = 7;
  int64 total_completed = 8;
  int64 total_errored = 9;
  int64 total_started = 10;
  int64 total_scheduled = 11;
}

message WfSpecMetrics {
  WfSpecId wf_spec_id = 1;
  google.protobuf.Timestamp window_start = 2;
  MetricsWindowLength type = 3;

  int64 total_started = 4;
  int64 total_completed = 5;
  int64 total_errored = 6;
  int64 start_to_complete_max = 7;
  int64 start_to_complete_avg = 8;
}

message ListUserTaskRunRequest {
  WfRunId wf_run_id = 1;
}

message UserTaskRunList {
  repeated UserTaskRun results = 1;
}

message ListTaskRunsRequest {
  WfRunId wf_run_id = 1;
}

message TaskRunList {
  repeated TaskRun results = 1;
}

message MigrateWfSpecRequest {
  WfSpecId old_wf_spec = 1;
  WfSpecVersionMigration migration = 2;
}

message GetLatestWfSpecRequest {
  string name = 1;
  optional int32 major_version = 2;
}

message ServerVersionResponse {
  int32 major_version = 1;
  int32 minor_version = 2;
  int32 patch_version = 3;
  optional string pre_release_identifier = 4;
}

service LittleHorse {
  rpc PutTaskDef(PutTaskDefRequest) returns (TaskDef) {}
  rpc GetTaskDef(TaskDefId) returns (TaskDef) {}

  rpc PutExternalEventDef(PutExternalEventDefRequest) returns (ExternalEventDef) {}
  rpc GetExternalEventDef(ExternalEventDefId) returns (ExternalEventDef) {}

  rpc PutWfSpec(PutWfSpecRequest) returns (WfSpec) {}
  rpc GetWfSpec(WfSpecId) returns (WfSpec) {}
  rpc GetLatestWfSpec(GetLatestWfSpecRequest) returns (WfSpec) {}
  rpc MigrateWfSpec(MigrateWfSpecRequest) returns (WfSpec) {}

  rpc PutUserTaskDef(PutUserTaskDefRequest) returns (UserTaskDef) {}
  rpc GetUserTaskDef(UserTaskDefId) returns (UserTaskDef) {}
  rpc GetLatestUserTaskDef(GetLatestUserTaskDefRequest) returns (UserTaskDef) {}

  rpc RunWf(RunWfRequest) returns (WfRun) {}
  rpc GetWfRun(WfRunId) returns (WfRun) {}

  rpc GetUserTaskRun(UserTaskRunId) returns (UserTaskRun) {}
  rpc AssignUserTaskRun(AssignUserTaskRunRequest) returns (google.protobuf.Empty) {}
  rpc CompleteUserTaskRun(CompleteUserTaskRunRequest) returns (google.protobuf.Empty) {}
  rpc CancelUserTaskRun(CancelUserTaskRunRequest) returns (google.protobuf.Empty) {}
  rpc ListUserTaskRuns(ListUserTaskRunRequest) returns (UserTaskRunList) {}

  rpc GetNodeRun(NodeRunId) returns (NodeRun) {}
  rpc ListNodeRuns(ListNodeRunsRequest) returns (NodeRunList) {}

  rpc GetTaskRun(TaskRunId) returns (TaskRun) {}
  rpc ListTaskRuns(ListTaskRunsRequest) returns (TaskRunList) {}

  rpc GetVariable(VariableId) returns (Variable) {}
  rpc ListVariables(ListVariablesRequest) returns (VariableList) {}

  rpc PutExternalEvent(PutExternalEventRequest) returns (ExternalEvent) {}
  rpc GetExternalEvent(ExternalEventId) returns (ExternalEvent) {}
  rpc ListExternalEvents(ListExternalEventsRequest) returns (ExternalEventList) {}

  rpc SearchWfRun(SearchWfRunRequest) returns (WfRunIdList) {}
  rpc SearchNodeRun(SearchNodeRunRequest) returns (NodeRunIdList) {}
  rpc SearchTaskRun(SearchTaskRunRequest) returns (TaskRunIdList) {}
  rpc SearchUserTaskRun(SearchUserTaskRunRequest) returns (UserTaskRunIdList) {}
  rpc SearchVariable(SearchVariableRequest) returns (VariableIdList) {}
  rpc SearchExternalEvent(SearchExternalEventRequest) returns (ExternalEventIdList) {}

  rpc SearchTaskDef(SearchTaskDefRequest) returns (TaskDefIdList) {}
  rpc SearchUserTaskDef(SearchUserTaskDefRequest) returns (UserTaskDefIdList) {}
  rpc SearchWfSpec(SearchWfSpecRequest) returns (WfSpecIdList) {}
  rpc SearchExternalEventDef(SearchExternalEventDefRequest) returns (ExternalEventDefIdList) {}

  rpc RegisterTaskWorker(RegisterTaskWorkerRequest) returns (RegisterTaskWorkerResponse) {}
  rpc PollTask(stream PollTaskRequest) returns (stream PollTaskResponse) {}
  rpc ReportTask(ReportTaskRun) returns (google.protobuf.Empty) {}

  rpc StopWfRun(StopWfRunRequest) returns (google.protobuf.Empty) {}
  rpc ResumeWfRun(ResumeWfRunRequest) returns (google.protobuf.Empty) {}

  rpc DeleteWfRun(DeleteWfRunRequest) returns (google.protobuf.Empty) {}
  rpc DeleteTaskDef(DeleteTaskDefRequest) returns (google.protobuf.Empty) {}
  rpc DeleteWfSpec(DeleteWfSpecRequest) returns (google.protobuf.Empty) {}
  rpc DeleteUserTaskDef(DeleteUserTaskDefRequest) returns (google.protobuf.Empty) {}
  rpc DeleteExternalEventDef(DeleteExternalEventDefRequest) returns (google.protobuf.Empty) {}

  rpc GetTaskDefMetricsWindow(TaskDefMetricsQueryRequest) returns (TaskDefMetrics) {}
  rpc GetWfSpecMetricsWindow(WfSpecMetricsQueryRequest) returns (WfSpecMetrics) {}
  rpc ListTaskDefMetrics(ListTaskMetricsRequest) returns (ListTaskMetricsResponse) {}
  rpc ListWfSpecMetrics(ListWfMetricsRequest) returns (ListWfMetricsResponse) {}

  rpc PutTenant(PutTenantRequest) returns (Tenant) {}
  rpc PutPrincipal(PutPrincipalRequest) returns (Principal) {}
  rpc Whoami(google.protobuf.Empty) returns (Principal) {}

  rpc GetServerVersion(google.protobuf.Empty) returns (ServerVersionResponse) {}
}
